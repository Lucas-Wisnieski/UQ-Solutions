<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Program Summary</title>
    <style>
        body {
            font-family: 'Avenir Medium', 'Avenir', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: white;
            min-height: 100vh;
        }
        
        .container {
            width: 100%;
            max-width: 1392px;
            max-height: 1440px;
            margin: 0 auto;
            background: white;
            padding: 0;
            overflow: hidden;
        }
        
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            padding: 4px 0 4px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .title {
            font-size: 28px;
            font-weight: 700;
            color: #03304D;
            margin: 0;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            text-align: center;
        }
        
        .program-title {
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            font-size: 22px;
            font-weight: bold;
            color: #03304d;
            margin: 20px 0 15px 0;
            text-align: left;
        }
        
        .refresh-btn {
            background: #333333;
            color: white;
            border: none;
            padding: 4px;
            border-radius: 0;
            cursor: pointer;
            font-weight: bold;
            font-family: "Avenir Medium", "Avenir", "Avenir Next", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            font-size: 12px;
            transition: all 0.3s ease;
            height: 39px;
            width: 188px;
            position: absolute;
            top: 4px;
            right: 20px;
        }
        
        .refresh-btn:hover {
            background: #024a73;
            transform: translateY(-1px);
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #e3f2fd;
            border-radius: 6px;
            color: #1976d2;
            font-weight: 500;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            border: 1px solid #bbdefb;
            margin-bottom: 16px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e3f2fd;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .summary-text {
            background: white;
            padding: 20px;
            min-height: 200px;
            font-size: 18px;
            line-height: 1.8;
            color: #2c3e50;
            white-space: pre-wrap;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
        }
        
        /* First line - lighter blue subtitle */
        .summary-text .subtitle {
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            font-size: 18px;
            color: #1AB2D7 !important;
            margin-bottom: 25px;
            line-height: 1.6;
            display: inline-block;
        }
        
        .summary-text h1,
        .summary-text h2 {
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            font-size: 32px;
            font-weight: bold;
            color: #03304D;
            margin: 30px 0 15px 0;
            line-height: 1.3;
        }
        
        .summary-text h3 {
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
            font-size: 28px;
            font-weight: bold;
            color: #03304D;
            margin: 25px 0 12px 0;
            line-height: 1.3;
        }
        
        .summary-text p {
            margin-bottom: 18px;
            line-height: 1.8;
        }
        
        .summary-text ul {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .summary-text li {
            margin-bottom: 14px;
            line-height: 1.8;
            font-size: 17px;
        }
        
        /* Make subtitle/description text bold and larger */
        .summary-text p:nth-of-type(2),
        .summary-text p:first-child:not([style*="display: none"]) {
            font-weight: 900;
            font-size: 19px;
            color: #2c3e50;
            font-style: italic;
            margin-bottom: 20px;
        }
        
        .summary-text table {
            margin: 40px auto;
            border-collapse: collapse;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-text th,
        .summary-text td {
            border: 1px solid #03304D;
            padding: 12px 20px;
            text-align: center;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
        }
        
        .summary-text th {
            background-color: #03304D;
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .summary-text td {
            background-color: #f8f9fa;
            font-size: 16px;
            color: #2c3e50;
        }
        
        .summary-text tr:last-child td {
            background-color: #e8f4f8;
            font-weight: bold;
            font-size: 17px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ffcdd2;
            margin-top: 16px;
            font-family: 'Avenir Medium', 'Avenir', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">New Program AI Summary</h1>
            <button class="refresh-btn" onclick="generateSummary()">Update Summary</button>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Analyzing program data...</span>
        </div>
        
        <div class="summary-container">
            <div class="summary-text" id="summaryText">
                Program analysis will appear here when triggered.
            </div>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
    </div>

    <script>
        console.log('üöÄ AI Summary Extension v2025.01.25.4 loaded');
        
        // API URLs
        const CLAUDE_API_URL = 'https://uq-solutions.vercel.app/api/claude';
        const GEMINI_API_URL = 'https://uq-solutions-gemini.vercel.app/api/gemini';
        
        // GitHub Pages URLs for Tableau API
        const GITHUB_API_URLS = [
            'https://lucas-wisnieski.github.io/UQ-Solutions/js/tableau.extensions.1.latest.js',
            'https://lucas-wisnieski.github.io/UQ-Solutions/js/tableau.extensions.1.latest.min.js'
        ];

        // Prompt URLs
        const CLAUDE_PROMPT_URL = 'https://raw.githubusercontent.com/Lucas-Wisnieski/UQ-Solutions/main/prompts/ai-analysis-prompt.txt';
        const GEMINI_PROMPT_URL = 'https://raw.githubusercontent.com/Lucas-Wisnieski/UQ-Solutions/main/prompts/institution-analysis-prompt.txt';

        // Global state
        let isProcessing = false;
        let claudePrompt = null;
        let geminiPrompt = null;
        let detectedMode = null;
        let lastTriggerCheck = 0;

        // Check for triggers from multiple sources
        function checkForTriggers() {
            // Check for completed summary results
            try {
                const storedResult = localStorage.getItem('ai-summary-result');
                if (storedResult) {
                    const resultData = JSON.parse(storedResult);
                    if (resultData.timestamp > lastTriggerCheck) {
                        localStorage.removeItem('ai-summary-result'); // Clear it
                        lastTriggerCheck = Date.now();
                        displayExternalSummary(resultData.content);
                        return;
                    }
                }
            } catch (e) {
                // Ignore localStorage errors
            }
            
            // Check Tableau settings for completed summary
            if (typeof tableau !== 'undefined' && tableau.extensions && tableau.extensions.settings) {
                try {
                    const summaryContent = tableau.extensions.settings.get('ai-summary-content');
                    const summaryTimestamp = tableau.extensions.settings.get('ai-summary-timestamp');
                    
                    if (summaryContent && summaryTimestamp && parseInt(summaryTimestamp) > lastTriggerCheck) {
                        tableau.extensions.settings.set('ai-summary-content', ''); // Clear it
                        tableau.extensions.settings.set('ai-summary-timestamp', '');
                        lastTriggerCheck = Date.now();
                        displayExternalSummary(summaryContent);
                        return;
                    }
                } catch (e) {
                    // Ignore settings errors
                }
            }
            
            // Legacy trigger checking (keep for backwards compatibility)
            try {
                const storedTrigger = localStorage.getItem('ai-summary-trigger');
                if (storedTrigger) {
                    const triggerData = JSON.parse(storedTrigger);
                    if (triggerData.timestamp > lastTriggerCheck) {
                        localStorage.removeItem('ai-summary-trigger'); // Clear it
                        lastTriggerCheck = Date.now();
                        generateSummary();
                        return;
                    }
                }
            } catch (e) {
                // Ignore localStorage errors
            }
        }

        // Start polling for triggers
        setInterval(checkForTriggers, 500); // Check every 500ms

        // üÜï ADD MESSAGE LISTENER FOR TRIGGER BUTTON COMMUNICATION
        window.addEventListener('message', function(event) {
            // Check for trigger message
            if (event.data && event.data.type === 'TRIGGER_AI_SUMMARY') {
                lastTriggerCheck = Date.now();
                generateSummary();
            }
            
            // Check for direct summary display message
            else if (event.data && event.data.type === 'DISPLAY_AI_SUMMARY') {
                // Display the summary directly in main extension
                if (event.data.summary) {
                    displayExternalSummary(event.data.summary);
                }
            }
        });

        console.log('‚úÖ Main extension message listener initialized');

        function displayExternalSummary(summaryText) {
            console.log('üìã Displaying external AI summary in main extension...');
            
            // Enhanced conversion to catch different heading patterns
            let htmlSummary = summaryText
                // Convert standalone bold lines to h2 (for section headings)
                .replace(/^(?:\*\*)?([A-Z][^:.\n]+(?::|$))(?:\*\*)?$/gm, '<h2>$1</h2>')
                // Convert "Why we like it:", "Potential concerns:", etc. to h2
                .replace(/^(Why we like it|Potential concerns|Overall assessment)[:]*$/gmi, '<h2>$1</h2>')
                // Convert ## markdown headings
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                // Convert **text** on its own line to h2
                .replace(/^\*\*(.*?)\*\*$/gm, '<h2>$1</h2>')
                // Remove remaining ** markdown for inline bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                // Clean up any colons after h2 tags
                .replace(/<h2>([^<]+):<\/h2>/g, '<h2>$1</h2>');
            
            // Remove only the "MARKET OUTLOOK SUMMARY" header, keep the description
            let lines = htmlSummary.split('<br>');
            
            // Remove only specific header lines, not content
            lines = lines.filter(line => {
                const cleanLine = line.replace(/<[^>]*>/g, '').trim().toUpperCase();
                // Only remove these specific headers
                return !(cleanLine === 'MARKET OUTLOOK SUMMARY' || 
                        cleanLine === 'MARKET OUTLOOK' ||
                        cleanLine === 'SUMMARY' ||
                        cleanLine === '');
            });
            
            // Apply blue color to first actual content line (the market outlook description)
            if (lines.length > 0 && lines[0] && !lines[0].includes('<h2>')) {
                lines[0] = `<span style="color: #1AB2D7 !important; font-size: 18px; display: block; margin-bottom: 20px;">${lines[0]}</span>`;
            }
            
            htmlSummary = lines.join('<br>');
            
            // Wrap in paragraph tags if not already formatted
            if (!htmlSummary.includes('<p>')) {
                htmlSummary = '<p>' + htmlSummary + '</p>';
            }
            
            console.log('üîç HTML Summary after conversion:', htmlSummary.substring(0, 500));
            
            // Display in the main summary area without additional title
            document.getElementById('summaryText').innerHTML = htmlSummary;
            
            // Hide loading if it's showing
            document.getElementById('loadingIndicator').style.display = 'none';
            hideError();
            
            console.log('‚úÖ External summary displayed successfully in main extension');
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up...');
            
            try {
                console.log('‚úÖ Main extension initialized');
                loadPrompts();
            } catch (error) {
                console.error('Setup error:', error);
                showError('Extension setup failed: ' + error.message);
            }
        });

        function loadPrompts() {
            console.log('üîç Loading prompts from GitHub...');
            
            Promise.all([
                fetch(CLAUDE_PROMPT_URL).then(r => r.text()),
                fetch(GEMINI_PROMPT_URL).then(r => r.text())
            ])
            .then(function([claudeText, geminiText]) {
                claudePrompt = claudeText.trim();
                geminiPrompt = geminiText.trim();
                console.log('‚úÖ Claude prompt loaded:', claudePrompt.length, 'characters');
                console.log('‚úÖ Gemini prompt loaded:', geminiPrompt.length, 'characters');
                
                loadTableauAPI();
            })
            .catch(function(error) {
                console.error('‚ùå Failed to load prompts:', error);
                showError('Failed to load analysis prompts: ' + error.message);
            });
        }

        function loadTableauAPI() {
            console.log('üîç Loading Tableau API...');
            
            if (typeof tableau !== 'undefined' && tableau.extensions) {
                console.log('‚úÖ Tableau API already available');
                initializeExtension();
                return;
            }

            const urls = [
                ...GITHUB_API_URLS,
                'https://raw.githubusercontent.com/tableau/extensions-api/master/lib/tableau.extensions.1.latest.js'
            ];

            let currentIndex = 0;

            function tryLoad() {
                if (currentIndex >= urls.length) {
                    console.log('‚ùå All API loading attempts failed');
                    return;
                }

                const url = urls[currentIndex];
                console.log(`üîÑ Trying: ${url}`);

                const script = document.createElement('script');
                script.src = url;
                
                script.onload = function() {
                    console.log(`‚úÖ Loaded from: ${url}`);
                    if (typeof tableau !== 'undefined' && tableau.extensions) {
                        initializeExtension();
                    }
                };
                
                script.onerror = function() {
                    console.log(`‚ùå Failed: ${url}`);
                    currentIndex++;
                    setTimeout(tryLoad, 100);
                };
                
                document.head.appendChild(script);
            }

            tryLoad();
        }

        function initializeExtension() {
            if (tableau && tableau.extensions) {
                tableau.extensions.initializeAsync()
                    .then(function() {
                        console.log('üéâ Extension initialized!');
                        updateButtonText();
                                                
                        // Auto-generate summary after a short delay to ensure everything is loaded
                        setTimeout(function() {
                            console.log('üîÑ Auto-generating summary on page load...');
                            generateSummary();
                        }, 200); // 0.2 second delay
                        
                    })
                    .catch(function(error) {
                        console.error('‚ùå Init failed:', error);
                    });
            }
        }

        function updateButtonText() {
            console.log('üìù Button text update');
        }

        function generateSummary() {
            if (isProcessing) {
                return;
            }
            
            if (!claudePrompt || !geminiPrompt) {
                showError('Prompts not loaded. Please refresh the page and try again.');
                return;
            }
            
            isProcessing = true;
            
            document.getElementById('loadingIndicator').style.display = 'block';
            hideError();
            
            setTimeout(function() {
                if (isProcessing) {
                    isProcessing = false;
                    document.getElementById('loadingIndicator').style.display = 'none';
                    showError('Process timed out after 45 seconds');
                }
            }, 45000);
            
            detectDashboardType()
                .then(function(data) {
                    console.log('‚úÖ Data extracted:', data);
                    console.log('üéØ Detected mode:', detectedMode);
                    
                    return callAPI(data);
                })
                .then(function(summary) {
                    // Enhanced conversion to catch different heading patterns
                    let htmlSummary = summary
                        // Convert standalone bold lines to h2 (for section headings)
                        .replace(/^(?:\*\*)?([A-Z][^:.\n]+(?::|$))(?:\*\*)?$/gm, '<h2>$1</h2>')
                        // Convert "Why we like it:", "Potential concerns:", etc. to h2
                        .replace(/^(Why we like it|Potential concerns|Overall assessment)[:]*$/gmi, '<h2>$1</h2>')
                        // Convert ## markdown headings
                        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                        // Convert **text** on its own line to h2
                        .replace(/^\*\*(.*?)\*\*$/gm, '<h2>$1</h2>')
                        // Remove remaining ** markdown for inline bold
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n/g, '<br>')
                        // Clean up any colons after h2 tags
                        .replace(/<h2>([^<]+):<\/h2>/g, '<h2>$1</h2>');
                    
                    // Remove only the "MARKET OUTLOOK SUMMARY" header line
                    let lines = htmlSummary.split('<br>');
                    
                    // Filter out only the header, keep the description
                    lines = lines.filter((line, index) => {
                        const cleanLine = line.replace(/<[^>]*>/g, '').trim().toUpperCase();
                        // Only remove these specific headers
                        if (cleanLine === 'MARKET OUTLOOK SUMMARY' || 
                            cleanLine === 'MARKET OUTLOOK' ||
                            cleanLine === 'SUMMARY') {
                            return false;
                        }
                        // Keep everything else including empty lines for spacing
                        return true;
                    });
                    
                    // Apply blue color to first actual content line (market outlook description)
                    let colorApplied = false;
                    for (let i = 0; i < lines.length; i++) {
                        if (lines[i] && lines[i].trim() !== '' && !lines[i].includes('<h2>') && !colorApplied) {
                            lines[i] = `<span style="color: #1AB2D7 !important; font-size: 18px; display: block; margin-bottom: 20px;">${lines[i]}</span>`;
                            colorApplied = true;
                            break;
                        }
                    }
                    
                    htmlSummary = lines.join('<br>');
                    
                    console.log('üîç HTML Summary after conversion:', htmlSummary.substring(0, 500));
                    
                    // Convert Category | Score table to HTML table
                    if (detectedMode === 'metrics' || htmlSummary.includes('Category | Score')) {
                        // First try to match the simple text format
                        htmlSummary = htmlSummary.replace(
                            /Category \| Score[\s\S]*?Total Score[^|]*\|[^0-9]*([\d.]+)/,
                            function(match) {
                                // Parse the text block into rows
                                const lines = match.split(/\n|<br>/);
                                let tableHTML = '<table><thead><tr><th>Category</th><th>Score</th></tr></thead><tbody>';
                                
                                lines.forEach(line => {
                                    // Skip header and separator lines
                                    if (line.includes('Category | Score') || line.includes('---') || !line.trim()) {
                                        return;
                                    }
                                    
                                    // Check if it's the total score line
                                    if (line.includes('Total Score')) {
                                        const totalMatch = line.match(/Total Score[^|]*\|[^0-9]*([\d.]+)/);
                                        if (totalMatch) {
                                            const formattedTotalScore = parseFloat(totalMatch[1]).toFixed(1);
                                            tableHTML += `<tr><td><strong>Total Score (Max 10)</strong></td><td><strong>${formattedTotalScore}</strong></td></tr>`;
                                        }
                                    } else if (line.includes('|')) {
                                        // Parse regular score lines
                                        const parts = line.split('|');
                                        if (parts.length >= 2) {
                                            const category = parts[0].trim();
                                            const scoreText = parts[1].trim();
                                            const scoreMatch = scoreText.match(/([\d.]+)/);
                                            if (scoreMatch) {
                                                const score = parseFloat(scoreMatch[1]).toFixed(1);
                                                tableHTML += `<tr><td>${category}</td><td>${score}</td></tr>`;
                                            }
                                        }
                                    }
                                });
                                
                                tableHTML += '</tbody></table>';
                                return tableHTML;
                            }
                        );
                    }
                    
                    document.getElementById('summaryText').innerHTML = htmlSummary;
                })
                .catch(function(error) {
                    console.error('‚ùå Failed:', error);
                    showError('Failed: ' + error.message);
                })
                .finally(function() {
                    isProcessing = false;
                    document.getElementById('loadingIndicator').style.display = 'none';
                });
        }

        function detectDashboardType() {
            return new Promise(function(resolve, reject) {
                if (typeof tableau === 'undefined' || !tableau.extensions) {
                    reject(new Error('Tableau API not available'));
                    return;
                }

                try {
                    const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
                    console.log(`Found ${worksheets.length} worksheets`);
                    
                    worksheets.forEach((ws, i) => {
                        console.log(`Worksheet ${i + 1}: "${ws.name}"`);
                    });
                    
                    const hasInstitutionTables = worksheets.some(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('institution')
                    );
                    
                    const hasMetricsTables = worksheets.some(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('metrics')
                    );
                    
                    if (hasInstitutionTables) {
                        detectedMode = 'institutions';
                        console.log('üèõÔ∏è Detected: Institution Analysis Dashboard');
                        extractInstitutionData(worksheets).then(resolve).catch(reject);
                    } else if (hasMetricsTables) {
                        detectedMode = 'metrics';
                        console.log('üìä Detected: Program Metrics Dashboard');
                        extractData().then(resolve).catch(reject);
                    } else {
                        reject(new Error('No recognized Claude worksheets found'));
                    }
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        function extractInstitutionData(worksheets) {
            return new Promise(function(resolve, reject) {
                try {
                    let secondaryInstitutionsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('secondary') &&
                        ws.name.toLowerCase().includes('institution')
                    );
                    
                    let tertiaryInstitutionsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('tertiary') &&
                        ws.name.toLowerCase().includes('institution')
                    );

                    if (!secondaryInstitutionsWs && !tertiaryInstitutionsWs) {
                        reject(new Error('No institution worksheets found'));
                        return;
                    }

                    console.log(`Found secondary institutions: "${secondaryInstitutionsWs?.name || 'None'}"`);
                    console.log(`Found tertiary institutions: "${tertiaryInstitutionsWs?.name || 'None'}"`);

                    Promise.all([
                        secondaryInstitutionsWs ? secondaryInstitutionsWs.getSummaryDataAsync() : Promise.resolve(null),
                        tertiaryInstitutionsWs ? tertiaryInstitutionsWs.getSummaryDataAsync() : Promise.resolve(null)
                    ])
                    .then(function([secondaryData, tertiaryData]) {
                        let secondaryInstitutions = [];
                        let tertiaryInstitutions = [];
                        
                        if (secondaryData) {
                            console.log(`Got ${secondaryData.data.length} secondary institution rows`);
                            secondaryInstitutions = extractInstitutionNames(secondaryData);
                        }
                        
                        if (tertiaryData) {
                            console.log(`Got ${tertiaryData.data.length} tertiary institution rows`);
                            tertiaryInstitutions = extractInstitutionNames(tertiaryData);
                        }

                        // Extract program and job from the institution data
                        let currentProgram = 'Program Analysis';
                        let currentJob = 'Various Careers';
                        
                        if (secondaryData && secondaryData.data.length > 0) {
                            const firstRow = secondaryData.data[0];
                            const columns = secondaryData.columns.map(col => col.fieldName);
                            
                            const cipIndex = columns.findIndex(col => 
                                col.toLowerCase().includes('cip') || 
                                col.toLowerCase().includes('award') ||
                                col.toLowerCase().includes('program')
                            );
                            
                            if (cipIndex >= 0 && firstRow[cipIndex]) {
                                const cipValue = (typeof firstRow[cipIndex] === 'object' && firstRow[cipIndex].value !== undefined) 
                                    ? firstRow[cipIndex].value : firstRow[cipIndex];
                                if (cipValue && cipValue !== '%null%') {
                                    currentProgram = cipValue;
                                    console.log('üìä Current program from institution data:', currentProgram);
                                }
                            }
                        } else if (tertiaryData && tertiaryData.data.length > 0) {
                            const firstRow = tertiaryData.data[0];
                            const columns = tertiaryData.columns.map(col => col.fieldName);
                            
                            const cipIndex = columns.findIndex(col => 
                                col.toLowerCase().includes('cip') || 
                                col.toLowerCase().includes('award') ||
                                col.toLowerCase().includes('program')
                            );
                            
                            if (cipIndex >= 0 && firstRow[cipIndex]) {
                                const cipValue = (typeof firstRow[cipIndex] === 'object' && firstRow[cipIndex].value !== undefined) 
                                    ? firstRow[cipIndex].value : firstRow[cipIndex];
                                if (cipValue && cipValue !== '%null%') {
                                    currentProgram = cipValue;
                                    console.log('üìä Current program from institution data:', currentProgram);
                                }
                            }
                        }

                        resolve({
                            program: currentProgram,
                            jobTarget: currentJob,
                            secondaryInstitutions: secondaryInstitutions,
                            tertiaryInstitutions: tertiaryInstitutions,
                            dataSource: 'Institution Data (Tableau View)',
                            timestamp: new Date().toLocaleString()
                        });
                    })
                    .catch(function(error) {
                        console.error('Institution data extraction error:', error);
                        reject(new Error('Institution data extraction failed: ' + error.message));
                    });

                } catch (error) {
                    reject(error);
                }
            });
        }

        function extractInstitutionNames(dataTable) {
            const columns = dataTable.columns.map(col => col.fieldName);
            const rows = dataTable.data;
            
            console.log('Institution table columns:', columns);
            
            const institutionColumnIndex = columns.findIndex(col => 
                col.toLowerCase() === 'institution'
            );
            
            if (institutionColumnIndex === -1) {
                const fallbackIndex = columns.findIndex(col => 
                    col.toLowerCase().includes('institution') ||
                    col.toLowerCase().includes('school') ||
                    col.toLowerCase().includes('university') ||
                    col.toLowerCase().includes('college')
                );
                
                if (fallbackIndex === -1) {
                    console.log('‚ö†Ô∏è No institution column found');
                    return [];
                }
                
                console.log(`Found institution column at index ${fallbackIndex}: "${columns[fallbackIndex]}"`);
                const institutionColumnIndex = fallbackIndex;
            } else {
                console.log(`Found institution column at index ${institutionColumnIndex}: "${columns[institutionColumnIndex]}"`);
            }
            
            const institutions = [];
            
            rows.forEach(function(row, index) {
                if (row[institutionColumnIndex]) {
                    let institutionName = row[institutionColumnIndex];
                    
                    if (typeof institutionName === 'object' && institutionName._formattedValue) {
                        institutionName = institutionName._formattedValue;
                    } else if (typeof institutionName === 'object' && institutionName._value) {
                        institutionName = institutionName._value;
                    } else if (typeof institutionName === 'object' && institutionName.value !== undefined) {
                        institutionName = institutionName.value;
                    }
                    
                    if (institutionName && typeof institutionName === 'string' && institutionName.trim() !== '') {
                        const cleanName = institutionName.trim();
                        if (!institutions.includes(cleanName) && !cleanName.includes('|')) {
                            institutions.push(cleanName);
                            console.log(`Found institution ${institutions.length}: ${cleanName}`);
                        }
                    }
                }
            });
            
            console.log(`Extracted ${institutions.length} unique institutions`);
            return institutions;
        }

        function extractData() {
            return new Promise(function(resolve, reject) {
                if (typeof tableau === 'undefined' || !tableau.extensions) {
                    reject(new Error('Tableau API not available'));
                    return;
                }

                try {
                    const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
                    console.log(`Found ${worksheets.length} worksheets`);
                    
                    let target = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && ws.name.toLowerCase().includes('metrics')
                    );
                    
                    let secondaryInstitutionsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('secondary') &&
                        ws.name.toLowerCase().includes('institution')
                    );
                    
                    let tertiaryInstitutionsWs = worksheets.find(ws => 
                        ws.name.toLowerCase().includes('claude') && 
                        ws.name.toLowerCase().includes('tertiary') &&
                        ws.name.toLowerCase().includes('institution')
                    );
                    
                    if (!target && worksheets.length > 0) {
                        target = worksheets[0];
                    }
                    
                    if (!target) {
                        reject(new Error('No worksheets found'));
                        return;
                    }
                    
                    console.log(`Using main worksheet: "${target.name}"`);
                    if (secondaryInstitutionsWs) console.log(`Found secondary institutions: "${secondaryInstitutionsWs.name}"`);
                    if (tertiaryInstitutionsWs) console.log(`Found tertiary institutions: "${tertiaryInstitutionsWs.name}"`);
                    
                    Promise.all([
                        target.getSummaryDataAsync(),
                        secondaryInstitutionsWs ? secondaryInstitutionsWs.getSummaryDataAsync() : Promise.resolve(null),
                        tertiaryInstitutionsWs ? tertiaryInstitutionsWs.getSummaryDataAsync() : Promise.resolve(null)
                    ])
                        .then(function([summaryData, secondaryData, tertiaryData]) {
                            console.log(`Got ${summaryData.data.length} summary rows`);
                            
                            let secondaryInstitutions = [];
                            let tertiaryInstitutions = [];
                            
                            if (secondaryData) {
                                console.log(`Got ${secondaryData.data.length} secondary institution rows`);
                                secondaryInstitutions = extractInstitutionNames(secondaryData);
                            }
                            
                            if (tertiaryData) {
                                console.log(`Got ${tertiaryData.data.length} tertiary institution rows`);
                                tertiaryInstitutions = extractInstitutionNames(tertiaryData);
                            }
                            
                            if (summaryData.data.length > 0) {
                                const data = processSummaryData(summaryData);
                                if (data.metrics.length >= 3) {
                                    console.log('‚úÖ Using summary data with', data.metrics.length, 'metrics');
                                    
                                    data.secondaryInstitutions = secondaryInstitutions;
                                    data.tertiaryInstitutions = tertiaryInstitutions;
                                    
                                    resolve(data);
                                    return;
                                } else {
                                    console.log(`‚ö†Ô∏è Summary data has only ${data.metrics.length} metrics, trying underlying data...`);
                                }
                            }
                            
                            console.log('Summary data insufficient, trying underlying data...');
                            return target.getUnderlyingDataAsync();
                        })
                        .then(function(underlyingData) {
                            if (!underlyingData) {
                                reject(new Error('No underlying data available'));
                                return;
                            }
                            
                            console.log(`Got ${underlyingData.data.length} underlying rows`);
                            const data = processUnderlyingData(underlyingData);
                            
                            if (data.metrics.length === 0) {
                                reject(new Error('No meaningful metrics found in underlying data'));
                                return;
                            }
                            
                            console.log('‚úÖ Using underlying data with', data.metrics.length, 'metrics');
                            resolve(data);
                        })
                        .catch(function(error) {
                            console.error('Data extraction error:', error);
                            reject(new Error('Data extraction failed: ' + error.message));
                        });
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        function processSummaryData(dataTable) {
            const columns = dataTable.columns.map(col => col.fieldName);
            const rows = dataTable.data;
            
            console.log('Summary columns:', columns);
            console.log('Summary rows:', rows.length);
            
            console.log('üîç DEBUG: First 10 rows complete structure:');
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const row = rows[i];
                console.log(`Row ${i}:`, {
                    cipCode: row[0],
                    uqJob: row[1], 
                    measureName: row[2],
                    measureValue: row[3]
                });
            }
            
            const metrics = [];
            
            const measureValuesIndex = columns.findIndex(col => 
                col.toLowerCase().includes('measure values') || 
                col.toLowerCase().includes('values')
            );
            
            const measureNamesIndex = columns.findIndex(col => 
                col.toLowerCase().includes('measure names') || 
                col.toLowerCase().includes('names')
            );
            
            console.log('Measure Values column index:', measureValuesIndex);
            console.log('Measure Names column index:', measureNamesIndex);
            
            if (measureValuesIndex >= 0 && measureNamesIndex >= 0) {
                console.log('‚úÖ Found Measure Names/Values columns - extracting ALL measure data...');
                
                rows.forEach(function(row, rowIndex) {
                    let measureName = null;
                    let measureValue = null;
                    
                    if (row[measureNamesIndex]) {
                        const nameCell = row[measureNamesIndex];
                        measureName = nameCell._formattedValue || nameCell.value || 
                                    (typeof nameCell === 'object' && nameCell.value !== undefined ? nameCell.value : nameCell);
                    }
                    
                    if (row[measureValuesIndex]) {
                        const valueCell = row[measureValuesIndex];
                        measureValue = valueCell._value || valueCell.value || 
                                     (typeof valueCell === 'object' && valueCell.value !== undefined ? valueCell.value : valueCell);
                    }
                    
                    if (measureName && typeof measureValue === 'number') {
                        const cleanName = measureName.trim();
                        
                        if (!metrics.some(m => m.name === cleanName)) {
                            console.log(`‚úÖ Found measure: ${cleanName} = ${measureValue}`);
                            
                            metrics.push({
                                name: cleanName,
                                value: measureValue,
                                originalName: measureName
                            });
                        }
                    }
                });
            } else {
                console.log('‚ö†Ô∏è Measure Names/Values columns not found, trying alternative approach...');
                
                rows.forEach(function(row, rowIndex) {
                    if (rowIndex < 10) {
                        columns.forEach(function(col, colIndex) {
                            if (row[colIndex]) {
                                let value = row[colIndex];
                                
                                if (typeof value === 'object' && value.value !== undefined) {
                                    value = value.value;
                                }
                                
                                if (typeof value === 'number' && !metrics.some(m => m.name === col)) {
                                    console.log(`‚úÖ Found direct measure: ${col} = ${value}`);
                                    metrics.push({
                                        name: col,
                                        value: value
                                    });
                                }
                            }
                        });
                    }
                });
            }
            
            console.log(`Summary data processing complete: ${metrics.length} metrics found`);
            
            let currentProgram = '11.0701 | Computer Science | Bachelor\'s';
            let currentJob = 'Software Developers';
            
            if (rows.length > 0) {
                const firstRow = rows[0];
                
                if (firstRow[0]) {
                    const cipValue = (typeof firstRow[0] === 'object' && firstRow[0].value !== undefined) 
                        ? firstRow[0].value : firstRow[0];
                    if (cipValue && cipValue !== '%null%') {
                        currentProgram = cipValue;
                        console.log('üìä Current program from data:', currentProgram);
                    }
                }
                
                if (firstRow[1]) {
                    const jobValue = (typeof firstRow[1] === 'object' && firstRow[1].value !== undefined) 
                        ? firstRow[1].value : firstRow[1];
                    if (jobValue && jobValue !== '%null%') {
                        currentJob = jobValue;
                        console.log('üéØ Current job from data:', currentJob);
                    }
                }
            }
            
            return {
                program: currentProgram,
                jobTarget: currentJob,
                metrics: metrics,
                dataSource: 'Summary Data (Tableau View)',
                recordCount: rows.length,
                timestamp: new Date().toLocaleString()
            };
        }

        function processUnderlyingData(dataTable) {
            const columns = dataTable.columns.map(col => col.fieldName);
            const rows = dataTable.data;
            
            console.log('Underlying columns count:', columns.length);
            console.log('Underlying rows count:', rows.length);
            
            const metrics = [];
            
            for (let i = 0; i < Math.min(rows.length, 10); i++) {
                const row = rows[i];
                
                columns.forEach(function(col, colIndex) {
                    if (row[colIndex]) {
                        let value = row[colIndex];
                        
                        if (typeof value === 'object' && value.value !== undefined) {
                            value = value.value;
                        }
                        
                        if (typeof value === 'number' && !metrics.some(m => m.name === col)) {
                            console.log(`‚úÖ Found metric in underlying: ${col} = ${value}`);
                            metrics.push({
                                name: col,
                                value: value
                            });
                        }
                    }
                });
            }
            
            return {
                program: '11.0701 | Computer Science | Bachelor\'s',
                jobTarget: 'Software Developers',
                metrics: metrics,
                dataSource: 'Underlying Data',
                recordCount: Math.min(rows.length, 100)
            };
        }

        function callAPI(data) {
            let prompt, apiUrl;
            
            if (detectedMode === 'institutions') {
                console.log('üîç Using Gemini for institution analysis');
                
                let institutionList = [];
                if (data.secondaryInstitutions) {
                    institutionList = institutionList.concat(data.secondaryInstitutions);
                }
                if (data.tertiaryInstitutions) {
                    institutionList = institutionList.concat(data.tertiaryInstitutions);
                }
                
                institutionList = [...new Set(institutionList)].slice(0, 20);
                
                prompt = geminiPrompt
                    .replace(/\[Program\]/g, data.program)
                    .replace(/\[List of institutions\]/g, institutionList.join(', '));
                
                apiUrl = GEMINI_API_URL;
                
            } else {
                console.log('üîç Using Claude for metrics analysis');
                
                let institutionText = '';
                if (data.secondaryInstitutions && data.secondaryInstitutions.length > 0) {
                    institutionText += `\n\nTOP INSTITUTIONS (SECONDARY MARKET):\n${data.secondaryInstitutions.slice(0, 10).map((inst, i) => `${i + 1}. ${inst}`).join('\n')}`;
                }
                if (data.tertiaryInstitutions && data.tertiaryInstitutions.length > 0) {
                    institutionText += `\n\nTOP INSTITUTIONS (TERTIARY MARKET):\n${data.tertiaryInstitutions.slice(0, 10).map((inst, i) => `${i + 1}. ${inst}`).join('\n')}`;
                }
                
                prompt = claudePrompt
                    .replace(/\{\{PROGRAM\}\}/g, data.program)
                    .replace(/\{\{JOB_TARGET\}\}/g, data.jobTarget)
                    .replace(/\{\{TIMESTAMP\}\}/g, data.timestamp)
                    .replace(/\{\{DATA_SOURCE\}\}/g, data.dataSource)
                    .replace(/\{\{METRICS\}\}/g, data.metrics.map(m => `‚Ä¢ ${m.name}: ${m.value}`).join('\n'))
                    .replace(/\{\{INSTITUTIONS\}\}/g, institutionText);
                
                apiUrl = CLAUDE_API_URL;
            }

            console.log('üöÄ Sending prompt to', detectedMode === 'institutions' ? 'Gemini' : 'Claude', 'API...');

            return fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: prompt })
            })
            .then(function(response) {
                console.log('API response status:', response.status);
                if (!response.ok) throw new Error('API error: ' + response.status);
                return response.json();
            })
            .then(function(result) {
                console.log('API result:', result);
                if (result && result.success) {
                    return result.content;
                } else {
                    throw new Error(result?.error || 'API returned error');
                }
            })
            .catch(function(error) {
                console.error('API error:', error);
                throw new Error('API failed: ' + error.message);
            });
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html>
