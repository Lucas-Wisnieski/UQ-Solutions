<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Program Summary</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://public.tableau.com/javascripts/api/tableau.extensions.1.latest.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
            color: #1976d2;
            font-weight: 500;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e3f2fd;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .summary-container {
            margin-top: 20px;
        }
        
        .summary-text {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 24px;
            min-height: 200px;
            font-size: 16px;
            line-height: 1.6;
            color: #2c3e50;
            white-space: pre-wrap;
        }
        
        .data-preview {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .data-preview h4 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .data-preview pre {
            margin: 0;
            font-size: 12px;
            color: #6c757d;
            overflow-x: auto;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #ffcdd2;
            margin-top: 20px;
        }
        
        .config-section {
            margin-top: 20px;
            padding: 16px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
        }
        
        .config-section h4 {
            margin: 0 0 12px 0;
            color: #856404;
        }
        
        .config-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">AI Program Summary</h1>
            <div>
                <button onclick="runDiagnostics()" style="margin-right: 10px; padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px;">
                    Run Diagnostics
                </button>
                <button class="refresh-btn" id="refreshBtn" onclick="generateSummary()">
                    Generate Summary
                </button>
            </div>
        </div>
        
        <div class="config-section" id="configSection">
            <h4>Configuration Required</h4>
            <p>Please enter your OpenAI API key to generate summaries:</p>
            <input type="password" class="config-input" id="apiKeyInput" placeholder="Enter your OpenAI API key">
            <button onclick="saveApiKey()" style="margin-top: 8px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px;">Save</button>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Analyzing program data and generating summary...</span>
        </div>
        
        <div class="summary-container">
            <div class="summary-text" id="summaryText">
                Click "Generate Summary" to analyze your program data and create an AI-powered summary.
            </div>
        </div>
        
        <div class="data-preview" id="dataPreview" style="display: none;">
            <h4>Current Data Preview:</h4>
            <pre id="dataContent"></pre>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
    </div>

    <!-- jQuery (required by Tableau Extensions API) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        let apiKey = '';
        
        // Initialize the extension - enhanced debugging
        function initializeExtension() {
            console.log('=== DEBUGGING TABLEAU CONNECTION ===');
            console.log('1. Initializing extension...');
            console.log('2. jQuery available:', typeof $);
            console.log('3. Document URL:', window.location.href);
            console.log('4. User Agent:', navigator.userAgent);
            console.log('5. Tableau object type:', typeof tableau);
            
            // Check if we're actually running inside Tableau
            console.log('6. Parent window:', window.parent !== window ? 'Has parent (likely in iframe)' : 'No parent (standalone)');
            console.log('7. Window name:', window.name);
            console.log('8. Referrer:', document.referrer);
            
            if (typeof tableau !== 'undefined') {
                console.log('9. Tableau object found!');
                console.log('   - Extensions available:', typeof tableau.extensions);
                console.log('   - Version info:', tableau.version || 'Not available');
                
                // Try to initialize
                console.log('10. Attempting to initialize Tableau Extensions API...');
                tableau.extensions.initializeAsync().then(function() {
                    console.log('✅ SUCCESS: Extension initialized successfully!');
                    console.log('11. Dashboard info:');
                    console.log('   - Name:', tableau.extensions.dashboardContent.dashboard.name);
                    console.log('   - Worksheets count:', tableau.extensions.dashboardContent.dashboard.worksheets.length);
                    
                    const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
                    worksheets.forEach((ws, index) => {
                        console.log(`   - Worksheet ${index + 1}: "${ws.name}"`);
                    });
                    
                    checkApiKey();
                }).catch(function(error) {
                    console.error('❌ FAILED: Error initializing extension:', error);
                    console.log('Error details:', error.message);
                    console.log('Error stack:', error.stack);
                    showError('Failed to initialize Tableau extension: ' + error.message);
                });
            } else {
                console.log('❌ Tableau object NOT FOUND');
                console.log('9. Possible reasons:');
                console.log('   - Extension not loaded within Tableau');
                console.log('   - Tableau Extensions API script failed to load');
                console.log('   - CORS/security restrictions');
                
                // Let's check what scripts loaded
                console.log('10. Checking loaded scripts:');
                const scripts = document.querySelectorAll('script');
                scripts.forEach((script, index) => {
                    console.log(`   Script ${index + 1}: ${script.src || 'inline script'}`);
                });
                
                // Check if we can detect Tableau environment
                console.log('11. Environment detection:');
                console.log('   - Is HTTPS:', window.location.protocol === 'https:');
                console.log('   - Domain:', window.location.hostname);
                console.log('   - In iframe:', window.frameElement !== null);
                
                showError('Tableau Extensions API not available. Please ensure this extension is loaded within Tableau Desktop or Tableau Cloud.');
            }
        }
        
        // Wait for both jQuery and DOM to be ready
        if (typeof $ !== 'undefined') {
            $(document).ready(initializeExtension);
        } else {
            // Fallback if jQuery doesn't load
            document.addEventListener('DOMContentLoaded', initializeExtension);
        }
        
        function checkApiKey() {
            // In a real implementation, you'd store this more securely
            apiKey = localStorage.getItem('openai_api_key');
            if (apiKey) {
                document.getElementById('configSection').style.display = 'none';
            } else {
                document.getElementById('configSection').style.display = 'block';
            }
        }
        
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            if (input.value.trim()) {
                apiKey = input.value.trim();
                localStorage.setItem('openai_api_key', apiKey);
                document.getElementById('configSection').style.display = 'none';
                input.value = '';
            }
        }
        
        async function generateSummary() {
            if (!apiKey) {
                showError('Please configure your OpenAI API key first.');
                return;
            }
            
            showLoading(true);
            hideError();
            
            try {
                // Get data from Tableau
                const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
                console.log('Found worksheets:', worksheets.map(w => w.name));
                
                // Try to find the worksheet with our data
                let targetWorksheet = worksheets.find(w => 
                    w.name.toLowerCase().includes('program') || 
                    w.name.toLowerCase().includes('score') ||
                    w.name.toLowerCase().includes('data')
                );
                
                // If no specific worksheet found, use the first one
                if (!targetWorksheet && worksheets.length > 0) {
                    targetWorksheet = worksheets[0];
                }
                
                if (!targetWorksheet) {
                    throw new Error('No worksheets found in the dashboard');
                }
                
                console.log('Using worksheet:', targetWorksheet.name);
                
                // Get the underlying data
                const dataTable = await targetWorksheet.getUnderlyingDataAsync();
                const data = processTableauData(dataTable);
                
                // Show data preview
                showDataPreview(data);
                
                // Generate AI summary
                const summary = await callOpenAI(data);
                
                // Display the summary
                document.getElementById('summaryText').textContent = summary;
                
            } catch (error) {
                console.error('Error generating summary:', error);
                showError('Error generating summary: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function processTableauData(dataTable) {
            const columns = dataTable.columns;
            const data = dataTable.data;
            
            // Convert Tableau data to a more readable format
            const processedData = data.map(row => {
                const rowObj = {};
                columns.forEach((col, index) => {
                    rowObj[col.fieldName] = row[index].value;
                });
                return rowObj;
            });
            
            return {
                columns: columns.map(col => col.fieldName),
                rows: processedData,
                totalRows: data.length
            };
        }
        
        async function callOpenAI(data) {
            const prompt = `Analyze the following program performance data and create a comprehensive summary:

Data Structure:
- Program: ${data.rows[0]?.['CIP Code & Award Level'] || 'Program data'}
- Job Target: ${data.rows[0]?.['UQ Job'] || 'Job information'}
- Metrics Available: ${data.columns.join(', ')}
- Total Data Points: ${data.totalRows}

Key Metrics from the data:
${data.rows.slice(0, 10).map(row => 
    `${row['Measure Names']}: ${row['Measure Values']}`
).join('\n')}

Please provide a clear, actionable summary that includes:
1. Overall program performance assessment
2. Key strengths and areas for improvement  
3. Market opportunity analysis
4. Recommendations for program development

Keep the summary concise but comprehensive, suitable for academic administrators and program directors.`;

            // Try direct API call first, then fallback to proxy if needed
            const apiUrls = [
                'https://api.openai.com/v1/chat/completions',
                'https://cors-anywhere.herokuapp.com/https://api.openai.com/v1/chat/completions'
            ];

            for (let i = 0; i < apiUrls.length; i++) {
                try {
                    console.log(`Trying API URL ${i + 1}:`, apiUrls[i]);
                    
                    const response = await fetch(apiUrls[i], {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`,
                            ...(i === 1 && { 'X-Requested-With': 'XMLHttpRequest' })
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [{
                                role: 'user',
                                content: prompt
                            }],
                            max_tokens: 800,
                            temperature: 0.7
                        })
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API error response:', errorText);
                        
                        if (i === apiUrls.length - 1) {
                            // Last attempt failed
                            throw new Error(`OpenAI API error: ${response.status}`);
                        }
                        continue; // Try next URL
                    }
                    
                    const result = await response.json();
                    console.log('OpenAI API success');
                    return result.choices[0].message.content;
                    
                } catch (error) {
                    console.error(`API attempt ${i + 1} failed:`, error);
                    
                    if (i === apiUrls.length - 1) {
                        // All attempts failed
                        if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            return `CORS Error: Direct API calls are blocked by the browser. 

For a working solution, you need to:
1. Set up a backend server to proxy OpenAI API calls, or
2. Use this extension in Tableau Server/Cloud where CORS restrictions may be different

Demo Summary Based on Your Data:
The Computer Science Bachelor's program shows a Total Score of 5.35 for Software Developer positions. Key metrics include:
- Market Growth Score: 0.2 (indicating limited growth)  
- Schools Like Us Score: 1.65 (competitive advantage)
- Opportunity Size Score: 0.8 (moderate opportunities)
- Workforce Demand Score: 2.0 (good demand)
- Earning Outcomes Score: 0.7 (decent salary prospects)

Recommendations:
1. Focus on the competitive advantage (Schools Like Us Score of 1.65)
2. Address the low market growth by exploring emerging tech areas
3. Leverage the strong workforce demand (2.0 score)
4. Consider program enhancements to improve earning outcomes

This is demo content - a real implementation would provide more detailed analysis.`;
                        } else {
                            throw error;
                        }
                    }
                }
            }
        }
        
        function showDataPreview(data) {
            const preview = document.getElementById('dataPreview');
            const content = document.getElementById('dataContent');
            
            const previewText = `Columns: ${data.columns.join(', ')}
            
Sample Data (first 5 rows):
${data.rows.slice(0, 5).map((row, i) => 
    `Row ${i + 1}: ${JSON.stringify(row, null, 2)}`
).join('\n\n')}

Total Rows: ${data.totalRows}`;
            
            content.textContent = previewText;
            preview.style.display = 'block';
        }
        
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('refreshBtn').disabled = show;
        }
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function runDiagnostics() {
            console.log('=== RUNNING TABLEAU DIAGNOSTICS ===');
            document.getElementById('summaryText').innerHTML = `
<strong>DIAGNOSTIC REPORT</strong>

Environment:
- URL: ${window.location.href}
- Protocol: ${window.location.protocol}
- Host: ${window.location.hostname}
- In iframe: ${window.frameElement !== null}
- Parent exists: ${window.parent !== window}
- Referrer: ${document.referrer || 'None'}

Tableau API:
- Tableau object: ${typeof tableau}
- jQuery loaded: ${typeof $ !== 'undefined'}
- User Agent: ${navigator.userAgent}

${typeof tableau !== 'undefined' ? 
`✅ Tableau API is available!
- Extensions: ${typeof tableau.extensions}
- Dashboard available: ${typeof tableau.extensions?.dashboardContent}
` : 
`❌ Tableau API not found
This suggests the extension is not running within Tableau, or the API failed to load.`}

Next steps: Check the browser console for detailed debugging information.
            `;
            
            // Also run the full diagnostic in console
            initializeExtension();
        }
    </script>
</body>
</html>
