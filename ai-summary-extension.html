<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AI Program Summary</title>
    <script src="https://unpkg.com/@tableau/extensions-api-types@latest/lib/tableau.extensions.1.latest.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .loading {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
            color: #1976d2;
            font-weight: 500;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e3f2fd;
            border-top: 2px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .summary-container {
            margin-top: 20px;
        }
        
        .summary-text {
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 24px;
            min-height: 200px;
            font-size: 16px;
            line-height: 1.6;
            color: #2c3e50;
            white-space: pre-wrap;
        }
        
        .data-preview {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .data-preview h4 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
        }
        
        .data-preview pre {
            margin: 0;
            font-size: 12px;
            color: #6c757d;
            overflow-x: auto;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #ffcdd2;
            margin-top: 20px;
        }
        
        .config-section {
            margin-top: 20px;
            padding: 16px;
            background: #fff3cd;
            border-radius: 8px;
            border: 1px solid #ffeaa7;
        }
        
        .config-section h4 {
            margin: 0 0 12px 0;
            color: #856404;
        }
        
        .config-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">AI Program Summary</h1>
            <button class="refresh-btn" id="refreshBtn" onclick="generateSummary()">
                Generate Summary
            </button>
        </div>
        
        <div class="config-section" id="configSection">
            <h4>Configuration Required</h4>
            <p>Please enter your OpenAI API key to generate summaries:</p>
            <input type="password" class="config-input" id="apiKeyInput" placeholder="Enter your OpenAI API key">
            <button onclick="saveApiKey()" style="margin-top: 8px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px;">Save</button>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <span>Analyzing program data and generating summary...</span>
        </div>
        
        <div class="summary-container">
            <div class="summary-text" id="summaryText">
                Click "Generate Summary" to analyze your program data and create an AI-powered summary.
            </div>
        </div>
        
        <div class="data-preview" id="dataPreview" style="display: none;">
            <h4>Current Data Preview:</h4>
            <pre id="dataContent"></pre>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
    </div>

    <script>
        let apiKey = '';
        
        // Initialize the extension
        $(document).ready(function() {
            tableau.extensions.initializeAsync().then(function() {
                console.log('Extension initialized successfully');
                checkApiKey();
            }).catch(function(error) {
                console.error('Error initializing extension:', error);
                showError('Failed to initialize Tableau extension: ' + error);
            });
        });
        
        function checkApiKey() {
            // In a real implementation, you'd store this more securely
            apiKey = localStorage.getItem('openai_api_key');
            if (apiKey) {
                document.getElementById('configSection').style.display = 'none';
            } else {
                document.getElementById('configSection').style.display = 'block';
            }
        }
        
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            if (input.value.trim()) {
                apiKey = input.value.trim();
                localStorage.setItem('openai_api_key', apiKey);
                document.getElementById('configSection').style.display = 'none';
                input.value = '';
            }
        }
        
        async function generateSummary() {
            if (!apiKey) {
                showError('Please configure your OpenAI API key first.');
                return;
            }
            
            showLoading(true);
            hideError();
            
            try {
                // Get data from Tableau
                const worksheets = tableau.extensions.dashboardContent.dashboard.worksheets;
                console.log('Found worksheets:', worksheets.map(w => w.name));
                
                // Try to find the worksheet with our data
                let targetWorksheet = worksheets.find(w => 
                    w.name.toLowerCase().includes('program') || 
                    w.name.toLowerCase().includes('score') ||
                    w.name.toLowerCase().includes('data')
                );
                
                // If no specific worksheet found, use the first one
                if (!targetWorksheet && worksheets.length > 0) {
                    targetWorksheet = worksheets[0];
                }
                
                if (!targetWorksheet) {
                    throw new Error('No worksheets found in the dashboard');
                }
                
                console.log('Using worksheet:', targetWorksheet.name);
                
                // Get the underlying data
                const dataTable = await targetWorksheet.getUnderlyingDataAsync();
                const data = processTableauData(dataTable);
                
                // Show data preview
                showDataPreview(data);
                
                // Generate AI summary
                const summary = await callOpenAI(data);
                
                // Display the summary
                document.getElementById('summaryText').textContent = summary;
                
            } catch (error) {
                console.error('Error generating summary:', error);
                showError('Error generating summary: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function processTableauData(dataTable) {
            const columns = dataTable.columns;
            const data = dataTable.data;
            
            // Convert Tableau data to a more readable format
            const processedData = data.map(row => {
                const rowObj = {};
                columns.forEach((col, index) => {
                    rowObj[col.fieldName] = row[index].value;
                });
                return rowObj;
            });
            
            return {
                columns: columns.map(col => col.fieldName),
                rows: processedData,
                totalRows: data.length
            };
        }
        
        async function callOpenAI(data) {
            const prompt = `Analyze the following program performance data and create a comprehensive summary:

Data Structure:
- Program: ${data.rows[0]?.['CIP Code & Award Level'] || 'Program data'}
- Job Target: ${data.rows[0]?.['UQ Job'] || 'Job information'}
- Metrics Available: ${data.columns.join(', ')}
- Total Data Points: ${data.totalRows}

Key Metrics from the data:
${data.rows.slice(0, 10).map(row => 
    `${row['Measure Names']}: ${row['Measure Values']}`
).join('\n')}

Please provide a clear, actionable summary that includes:
1. Overall program performance assessment
2. Key strengths and areas for improvement  
3. Market opportunity analysis
4. Recommendations for program development

Keep the summary concise but comprehensive, suitable for academic administrators and program directors.`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [{
                        role: 'user',
                        content: prompt
                    }],
                    max_tokens: 800,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(`OpenAI API error: ${response.status} - ${errorData?.error?.message || 'Unknown error'}`);
            }
            
            const result = await response.json();
            return result.choices[0].message.content;
        }
        
        function showDataPreview(data) {
            const preview = document.getElementById('dataPreview');
            const content = document.getElementById('dataContent');
            
            const previewText = `Columns: ${data.columns.join(', ')}
            
Sample Data (first 5 rows):
${data.rows.slice(0, 5).map((row, i) => 
    `Row ${i + 1}: ${JSON.stringify(row, null, 2)}`
).join('\n\n')}

Total Rows: ${data.totalRows}`;
            
            content.textContent = previewText;
            preview.style.display = 'block';
        }
        
        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
            document.getElementById('refreshBtn').disabled = show;
        }
        
        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
    
    <!-- jQuery (required by Tableau Extensions API) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>
</html>
